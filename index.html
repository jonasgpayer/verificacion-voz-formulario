recordBtn.onclick = async () => {
  try {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });

      audioChunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) {
          audioChunks.push(e.data);
        }
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        console.log('Blob creado:', audioBlob, 'size:', audioBlob.size);
        audioUrl = URL.createObjectURL(audioBlob);

        if (audioBlob.size > 0) {
          playBtn.disabled = resetBtn.disabled = sendBtn.disabled = false;
        } else {
          showAlert('La grabaci√≥n est√° vac√≠a. Intenta nuevamente.', 5000);
        }
      };

      mediaRecorder.start();
      startTime = Date.now();
      updateTimer();
      drawWave();

      recordBtn.textContent = '‚èπÔ∏è Detener';
      recordBtn.classList.add('recording');
    } else {
      mediaRecorder.requestData();
      mediaRecorder.stop();
      cancelAnimationFrame(animId);
      sourceNode.disconnect();

      recordBtn.textContent = 'üé§ Grabar';
      recordBtn.classList.remove('recording');
    }
  } catch (err) {
    console.error(err);
    showAlert('Activa el acceso al micr√≥fono para dictar', 6000);
  }
};
